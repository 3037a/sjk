rom flask import Flask, render_template, request, jsonify, session
import pymysql
import os

# ==================== è‡ªåŠ¨åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ ====================
def create_templates_if_not_exist():
    """åˆ›å»ºæ¨¡æ¿æ–‡ä»¶å¤¹å’ŒHTMLæ–‡ä»¶"""
    # ...ï¼ˆä¿æŒåŸæ¥çš„æ¨¡æ¿åˆ›å»ºä»£ç ä¸å˜ï¼‰...

# ==================== å…ˆåˆ›å»ºæ¨¡æ¿æ–‡ä»¶ ====================
create_templates_if_not_exist()

# ==================== Flaskåº”ç”¨ ====================
app = Flask(__name__)
app.secret_key = 'student_system_2024'

# ==================== æ•°æ®åº“é…ç½® ====================
DB_HOST = "localhost"
DB_USER = "root"
DB_PASSWORD = "20062013aa"  # ä½ çš„MySQLå¯†ç ï¼Œå¦‚æœæ²¡æœ‰å°±ç•™ç©º
DB_NAME = "score"

def get_db():
    """è¿æ¥æ•°æ®åº“"""
    try:
        conn = pymysql.connect(
            host=DB_HOST,
            user=DB_USER,
            password=DB_PASSWORD,
            database=DB_NAME,
            charset='utf8mb4',
            cursorclass=pymysql.cursors.DictCursor
        )
        return conn
    except Exception as e:
        print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return None

# ==================== APIæ¥å£ ====================

@app.route('/api/login', methods=['POST'])
def login():
    """ç”¨æˆ·ç™»å½•"""
    data = request.json
    username = data.get('username')
    password = data.get('password')

    print(f"ğŸ“ ç™»å½•å°è¯•: {username}/{password}")

    conn = get_db()
    if not conn:
        return jsonify({'success': False, 'message': 'æ•°æ®åº“è¿æ¥å¤±è´¥'})

    try:
        with conn.cursor() as cursor:
            # æŸ¥è¯¢ç”¨æˆ·
            sql = "SELECT id, username, password, role FROM users WHERE username = %s AND password = %s"
            cursor.execute(sql, (username, password))
            user = cursor.fetchone()

            if user:
                # å¦‚æœæ˜¯å­¦ç”Ÿï¼Œè·å–å­¦å·
                if user['role'] == 'student':
                    cursor.execute("SELECT student_id FROM students WHERE user_id = %s", user['id'])
                    student = cursor.fetchone()
                    if student:
                        user['student_id'] = student['student_id']

                print(f"âœ… ç™»å½•æˆåŠŸ: {username}")
                return jsonify({
                    'success': True,
                    'message': 'ç™»å½•æˆåŠŸ',
                    'data': user
                })
            else:
                print(f"âŒ ç™»å½•å¤±è´¥: {username}")
                return jsonify({'success': False, 'message': 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'})
    except Exception as e:
        print(f"âŒ ç™»å½•é”™è¯¯: {e}")
        return jsonify({'success': False, 'message': f'æœåŠ¡å™¨é”™è¯¯: {str(e)}'})
    finally:
        conn.close()

@app.route('/api/admin/students', methods=['GET'])
def get_all_students():
    """è·å–æ‰€æœ‰å­¦ç”Ÿä¿¡æ¯ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰"""
    conn = get_db()
    if not conn:
        return jsonify({'success': False, 'message': 'æ•°æ®åº“è¿æ¥å¤±è´¥'})

    try:
        with conn.cursor() as cursor:
            sql = """
                SELECT 
                    s.student_id,
                    s.name,
                    s.gender,
                    IFNULL(sc.total_score, 0) as score
                FROM students s
                LEFT JOIN scores sc ON s.student_id = sc.student_id
                ORDER BY s.student_id
            """
            cursor.execute(sql)
            students = cursor.fetchall()

            return jsonify({
                'success': True,
                'data': students
            })
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})
    finally:
        conn.close()

# ==================== æ–°æ·»åŠ çš„API ====================

@app.route('/api/admin/update_score', methods=['POST'])
def update_score():
    """æ›´æ–°å­¦ç”Ÿæˆç»©"""
    data = request.json
    student_id = data.get('student_id')
    new_score = data.get('score')

    print(f"ğŸ“ æ›´æ–°æˆç»©è¯·æ±‚: å­¦å·={student_id}, æ–°æˆç»©={new_score}")

    if not student_id or new_score is None:
        return jsonify({'success': False, 'message': 'å‚æ•°é”™è¯¯ï¼šç¼ºå°‘å­¦å·æˆ–æˆç»©'})

    try:
        # éªŒè¯æˆç»©æ˜¯æ•°å­—ä¸”åœ¨0-100ä¹‹é—´
        new_score = float(new_score)
        if new_score < 0 or new_score > 100:
            return jsonify({'success': False, 'message': 'æˆç»©å¿…é¡»åœ¨0-100ä¹‹é—´'})
    except ValueError:
        return jsonify({'success': False, 'message': 'æˆç»©å¿…é¡»æ˜¯æ•°å­—'})

    conn = get_db()
    if not conn:
        return jsonify({'success': False, 'message': 'æ•°æ®åº“è¿æ¥å¤±è´¥'})

    try:
        with conn.cursor() as cursor:
            # 1. æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å­˜åœ¨
            cursor.execute("SELECT student_id FROM students WHERE student_id = %s", (student_id,))
            student = cursor.fetchone()

            if not student:
                return jsonify({'success': False, 'message': f'å­¦å· {student_id} ä¸å­˜åœ¨'})

            # 2. æ›´æ–°æˆç»©ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™æ’å…¥ï¼‰
            sql = """
                INSERT INTO scores (student_id, total_score) 
                VALUES (%s, %s)
                ON DUPLICATE KEY UPDATE total_score = %s
            """
            cursor.execute(sql, (student_id, new_score, new_score))

            conn.commit()

            print(f"âœ… æˆç»©æ›´æ–°æˆåŠŸ: å­¦å·={student_id}, æ–°æˆç»©={new_score}")
            return jsonify({
                'success': True,
                'message': f'å­¦å· {student_id} çš„æˆç»©å·²æ›´æ–°ä¸º {new_score}'
            })
    except Exception as e:
        print(f"âŒ æ›´æ–°æˆç»©é”™è¯¯: {e}")
        return jsonify({'success': False, 'message': f'æ›´æ–°å¤±è´¥: {str(e)}'})
    finally:
        conn.close()

@app.route('/api/admin/delete_student', methods=['POST'])
def delete_student():
    """åˆ é™¤å­¦ç”Ÿ"""
    data = request.json
    student_id = data.get('student_id')

    print(f"ğŸ“ åˆ é™¤å­¦ç”Ÿè¯·æ±‚: å­¦å·={student_id}")

    if not student_id:
        return jsonify({'success': False, 'message': 'å‚æ•°é”™è¯¯ï¼šç¼ºå°‘å­¦å·'})

    conn = get_db()
    if not conn:
        return jsonify({'success': False, 'message': 'æ•°æ®åº“è¿æ¥å¤±è´¥'})

    try:
        with conn.cursor() as cursor:
            # 1. æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å­˜åœ¨
            cursor.execute("SELECT student_id, user_id FROM students WHERE student_id = %s", (student_id,))
            student = cursor.fetchone()

            if not student:
                return jsonify({'success': False, 'message': f'å­¦å· {student_id} ä¸å­˜åœ¨'})

            user_id = student['user_id']

            # 2. å…ˆåˆ é™¤ç”¨æˆ·ï¼ˆçº§è”åˆ é™¤å­¦ç”Ÿå’Œæˆç»©ï¼‰
            cursor.execute("DELETE FROM users WHERE id = %s", (user_id,))

            conn.commit()

            print(f"âœ… å­¦ç”Ÿåˆ é™¤æˆåŠŸ: å­¦å·={student_id}")
            return jsonify({
                'success': True,
                'message': f'å­¦å· {student_id} å·²åˆ é™¤'
            })
    except Exception as e:
        print(f"âŒ åˆ é™¤å­¦ç”Ÿé”™è¯¯: {e}")
        return jsonify({'success': False, 'message': f'åˆ é™¤å¤±è´¥: {str(e)}'})
    finally:
        conn.close()

@app.route('/api/student/myinfo', methods=['GET'])
def get_my_info():
    """å­¦ç”ŸæŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯"""
    student_id = request.args.get('student_id')

    if not student_id:
        return jsonify({'success': False, 'message': 'å‚æ•°é”™è¯¯ï¼šç¼ºå°‘å­¦å·'})

    conn = get_db()
    if not conn:
        return jsonify({'success': False, 'message': 'æ•°æ®åº“è¿æ¥å¤±è´¥'})

    try:
        with conn.cursor() as cursor:
            sql = """
                SELECT 
                    s.student_id,
                    s.name,
                    s.gender,
                    IFNULL(sc.total_score, 0) as score
                FROM students s
                LEFT JOIN scores sc ON s.student_id = sc.student_id
                WHERE s.student_id = %s
            """
            cursor.execute(sql, (student_id,))
            info = cursor.fetchone()

            if info:
                return jsonify({
                    'success': True,
                    'data': info
                })
            else:
                return jsonify({'success': False, 'message': 'å­¦ç”Ÿä¸å­˜åœ¨'})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})
    finally:
        conn.close()

# ==================== é¡µé¢è·¯ç”± ====================
@app.route('/')
def index():
    """é¦–é¡µï¼ˆç™»å½•é¡µï¼‰"""
    return render_template('login.html')

@app.route('/admin')
def admin():
    """ç®¡ç†å‘˜é¡µé¢"""
    return render_template('admin.html')

@app.route('/student')
def student():
    """å­¦ç”Ÿé¡µé¢"""
    return render_template('student.html')

# ==================== å¯åŠ¨æœåŠ¡å™¨ ====================
if __name__ == '__main__':
    print("=" * 50)
    print("ğŸ“ å­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿ")
    print("ğŸŒ è®¿é—®åœ°å€: http://localhost:5000")
    print("ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜è´¦å·: admin / 88888")
    print("ğŸ‘¨â€ğŸ“ å­¦ç”Ÿè´¦å·: 2023001 / 2023001")
    print("=" * 50)

    app.run(
        host='0.0.0.0',
        port=5000,
        debug=True
    )
